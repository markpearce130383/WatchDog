<script>
    // --- CONFIGURATION ---
    const APP_PASSWORD = "SecureHome"; 
    // YOUR N8N WEBHOOK URL
    const WEBHOOK_URL = "https://dtts.app.n8n.cloud/webhook/generate-report"; 
    // ---------------------

    // Storage for multiple images
    let storedImages = [];

    // --- HELPER: GENERATE UNIQUE ID ---
    function generateURN() {
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.random().toString(36).substring(2, 6).toUpperCase();
        return `RCT-${timestamp}-${random}`;
    }

    // --- HELPER: TOGGLE TEXT BOX VISIBILITY ---
    window.toggleDetail = (checkbox) => {
        const container = checkbox.closest('.checkbox-item');
        const detailBox = container.querySelector('.detail-box');
        if (checkbox.checked) {
            detailBox.classList.remove('hidden');
        } else {
            detailBox.classList.add('hidden');
        }
    };

    // --- MULTI-IMAGE COMPRESSION HELPER ---
    const fileInput = document.getElementById('dropzone-file');
    const fileNameDisplay = document.getElementById('file-name');

    // Function to compress a single file
    const processFile = (file) => {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const MAX_WIDTH = 800;
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= MAX_WIDTH / width;
                        width = MAX_WIDTH;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // Compress to JPEG 70% quality
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
            };
        });
    };

    fileInput.addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        fileNameDisplay.textContent = `Compressing ${files.length} images...`;
        
        // Clear previous images
        storedImages = [];

        // Process all files in parallel
        const promises = files.map(file => processFile(file));
        storedImages = await Promise.all(promises);

        fileNameDisplay.textContent = `âœ… Ready: ${files.length} images loaded`;
        fileNameDisplay.classList.add('text-emerald-500');
    });

    // --- DYNAMIC CHECKBOX GENERATOR ---
    const renderCheckbox = (name, value, label, isRisk = false) => {
        const borderColorClass = isRisk 
            ? 'border-red-200 dark:border-red-800 hover:border-red-500 bg-red-50 dark:bg-red-900/20' 
            : 'border-slate-200 dark:border-slate-600 hover:border-emerald-500 bg-white dark:bg-slate-700/50';
        
        const textColorClass = isRisk ? 'text-red-700 dark:text-red-300' : 'text-slate-700 dark:text-slate-300';
        const checkboxColor = isRisk ? 'text-red-500 focus:ring-red-500' : 'text-emerald-500 focus:ring-emerald-500';

        return `
        <div class="checkbox-item p-3 ${borderColorClass} border rounded-lg transition-all duration-200">
            <label class="flex items-center gap-3 cursor-pointer w-full">
                <input type="checkbox" name="${name}" value="${value}" onclick="toggleDetail(this)" class="w-4 h-4 ${checkboxColor} rounded">
                <span class="text-sm ${textColorClass} font-medium flex-1">${label}</span>
            </label>
            <div class="detail-box hidden pt-3 animate-fadeIn">
                <input type="text" placeholder="Add specific details..." 
                       class="detail-input w-full p-2 text-xs border-b border-slate-300 dark:border-slate-500 bg-transparent focus:border-emerald-500 outline-none ${textColorClass} placeholder-slate-400">
            </div>
        </div>
        `;
    };

    // --- LIST DATA (Keep your lists object here) ---
    // [Paste your existing 'const lists = { ... }' object here if needed, 
    // or keep the previous one if you didn't delete it. I am assuming 
    // the lists object exists from your previous code] 
    const lists = {
        merged_physical: [
            {val: "Fencing", lbl: "Fencing"}, {val: "Walls", lbl: "Walls"}, {val: "Gates", lbl: "Gates"},
            {val: "Hedging (Non-thorny)", lbl: "Hedging (Non-thorny)"}, {val: "Hedging (Thorny/Defensive)", lbl: "Hedging (Thorny)"},
            {val: "Secure Postal Delivery System", lbl: "Postal Delivery System"}, {val: "Deterrence Signage", lbl: "Deterrence Signage"},
            {val: "Egress Preventative Measures", lbl: "Egress Prevention"}, {val: "Security Film", lbl: "Security Film"},
            {val: "Window Shutters", lbl: "Window Shutters"}, {val: "Locking Systems", lbl: "Extra Locking Systems"},
            {val: "Intruder Alarm Contacts on Apertures", lbl: "Contacts on Apertures"}, {val: "Security Lighting", lbl: "Security Lighting (PIR/LED)"},
            {val: "CCTV", lbl: "CCTV System"}, {val: "Video Analytics", lbl: "Video Analytics"}, {val: "Guard Dogs", lbl: "Guard Dogs"},
            {val: "PIDs", lbl: "PIDs"}, {val: "LiDAR", lbl: "LiDAR Sensors"}, {val: "Intruder Alarm Beams", lbl: "Ext. Alarm Beams"},
        ],
        internal: [
            {val: "Intruder Alarm", lbl: "Intruder Alarm"}, {val: "PIR Sensors", lbl: "PIR Sensors"}, {val: "Internal CCTV", lbl: "Internal CCTV"}, 
            {val: "Monitoring", lbl: "Monitoring"}, {val: "Police Response", lbl: "Police Response"}, {val: "Security Patrols", lbl: "Security Patrols"},
            {val: "Key Fobs", lbl: "Key Fobs Used"}, {val: "All Fobs Accounted For", lbl: "Fobs Accounted For"}, {val: "Panic Alarms", lbl: "Panic Alarms"},
            {val: "Safe", lbl: "Safe"}, {val: "Quality/Graded Safe", lbl: "Quality/Graded Safe"}, {val: "Safe Alarmed", lbl: "Safe Alarmed"},
            {val: "Dummy Safe", lbl: "Dummy Safe"}, {val: "Panic Room/Secure Space", lbl: "Panic Room/Space"}, {val: "Comms in Secure Space", lbl: "Comms in Space"},
            {val: "Smoke Cloaks", lbl: "Smoke Cloaks"}, {val: "Strobe Lighting", lbl: "Strobe Lighting"}, {val: "High Value Items in Safe", lbl: "Items in Safe"},
        ],
        risks: [
            {val: "External Surveillance Positions Possible", lbl: "External Surveillance Holes", risk: true},
            {val: "Internal Surveillance Positions", lbl: "Internal Surveillance Positions", risk: true},
            {val: "Accessible Outbuildings/Sheds", lbl: "Accessible Outbuildings/Sheds", risk: true},
            {val: "Keys Hidden Outside", lbl: "Keys Hidden Outside", risk: true},
            {val: "Potential for Climbing", lbl: "Potential for Climbing", risk: true},
            {val: "Flat Surfaces to Aid Climbing", lbl: "Flat Surfaces to Aid Climbing", risk: true},
        ]
    };

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('merged_physical_grid').innerHTML = lists.merged_physical.map(i => renderCheckbox('merged_physical_feature', i.val, i.lbl, i.risk)).join('');
        document.getElementById('internal_grid').innerHTML = lists.internal.map(i => renderCheckbox('internal_feature', i.val, i.lbl, i.risk)).join('');
        document.getElementById('risk_grid').innerHTML = lists.risks.map(i => renderCheckbox('risk_feature', i.val, i.lbl, i.risk)).join('');
        lucide.createIcons();
    });

    // Theme and Login Logic (Keep existing)
    const themeToggle = document.getElementById('theme-toggle');
    if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
    themeToggle.addEventListener('click', () => {
      if (document.documentElement.classList.contains('dark')) {
        document.documentElement.classList.remove('dark');
        localStorage.setItem('color-theme', 'light');
      } else {
        document.documentElement.classList.add('dark');
        localStorage.setItem('color-theme', 'dark');
      }
      lucide.createIcons(); 
    });

    const loginScreen = document.getElementById('login-screen');
    const mainApp = document.getElementById('main-app');
    const views = {
      form: document.getElementById('view-form'),
      loading: document.getElementById('view-loading'),
      result: document.getElementById('view-result')
    };

    if (sessionStorage.getItem('isLoggedIn') === 'true') showApp();

    document.getElementById('loginForm').addEventListener('submit', (e) => {
      e.preventDefault();
      if (document.getElementById('password').value === APP_PASSWORD) {
        sessionStorage.setItem('isLoggedIn', 'true');
        showApp();
      } else {
        document.getElementById('loginError').textContent = "Access Denied: Incorrect Code.";
        document.getElementById('loginError').classList.remove('hidden');
      }
    });

    function showApp() {
      loginScreen.style.display = 'none';
      mainApp.style.display = 'block';
      lucide.createIcons();
    }

    // --- SUBMISSION HANDLER (FIXED) ---
    document.getElementById('riskForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const reportURN = generateURN();
      document.querySelector('#view-loading h2').innerText = `Processing Report #${reportURN}`;
      switchView('loading');

      const formData = new FormData(e.target);
      const getVal = (id) => document.getElementById(id).value;
      
      const getEnhancedChecks = (name) => {
        const checkedBoxes = document.querySelectorAll(`input[name="${name}"]:checked`);
        return Array.from(checkedBoxes).map(cb => {
            const container = cb.closest('.checkbox-item');
            const detailInput = container ? container.querySelector('.detail-input') : null;
            const detailText = detailInput && detailInput.value.trim() ? ` (Details: ${detailInput.value.trim()})` : '';
            return `${cb.value}${detailText}`;
        });
      };

      const physicalFeatures = getEnhancedChecks('merged_physical_feature');
      const accessPoints = getVal('accessPoints');
      if (accessPoints) physicalFeatures.push(`Access Points: ${accessPoints}`);

      const internalFeatures = getEnhancedChecks('internal_feature');
      const riskFeatures = getEnhancedChecks('risk_feature');

      const buildingScores = `Door Locks: ${getVal('doorScore')}/5, Wall Construction: ${getVal('wallScore')}/5, Glazing: ${getVal('glazingScore')}/5`;
      const internalScores = `False Alarm Rate: ${getVal('falseAlarmRate')}, People knowing code: ${getVal('peopleKnowingCode')}`;

      const opSec = `
        Code Changes: ${getVal('codeFreq')}
        Monitoring: ${getVal('monitoringSetup')}
        Lockdown: ${getVal('lockdownProc')}
        Open Windows: ${getVal('openWindowProc')}
        Drones: ${getVal('droneVuln')}
        Public Rights of Way: ${getVal('publicRights')}
        Insider Threat: ${getVal('insiderThreat')}
        Evac/Invac: ${getVal('invacEvac')}
        Neighbourhood Watch: ${getVal('neighbourScheme')}
        Assets/Trackers: ${getVal('assetTrackers')}
      `;

      const imageDesc = document.getElementById('imageDescription').value;

      const existingMeasuresSummary = `
        REPORT REFERENCE: ${reportURN}
        
        PROPERTY PROFILE: ${document.getElementById('securityProfile').value}

        PHYSICAL SECURITY & PERIMETER: ${physicalFeatures.join(', ') || 'None selected'}
        
        BUILDING HARDENING SCORES: ${buildingScores}
        
        INTERNAL SECURITY (DATA): ${internalScores}
        INTERNAL SECURITY PRESENT: ${internalFeatures.join(', ') || 'None selected'}

        IDENTIFIED VULNERABILITIES (RISKS): ${riskFeatures.join(', ') || 'None selected'}

        OPERATIONAL & ENVIRONMENT: ${opSec}

        SITE IMAGE CONTEXT: ${imageDesc}

        NOTES: ${formData.get('securityNotes').trim()}
      `;

      // 1. Send 'site_images' as an ARRAY of strings
      const payload = {
        unique_id: reportURN,
        address: formData.get('address'),
        email: formData.get('clientEmail'),
        details: formData.get('propertyDetails'),
        security_profile: document.getElementById('securityProfile').value,
        site_images: storedImages, // <--- SENDING THE ARRAY HERE
        existing_measures: existingMeasuresSummary
      };

      try {
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        // 2. SMART RESPONSE HANDLING (The Fix for Network Error)
        // We check the "Content-Type" header to see if n8n sent HTML or JSON.
        const contentType = res.headers.get("content-type");
        let htmlContent = "";

        if (contentType && contentType.indexOf("application/json") !== -1) {
            // It is JSON
            const result = await res.json();
            htmlContent = result.html || result.output || "<p>Report generated successfully.</p>";
        } else {
            // It is HTML (Text)
            htmlContent = await res.text();
        }

        if (res.ok) {
            // If the content is basically empty JSON, handle fallback
            if (htmlContent.includes("Report generated successfully") && htmlContent.length < 100) {
               // This handles the "Success but no content" case
            }

          const headerHTML = `
            <div class="mb-6 border-b border-slate-200 dark:border-slate-700 pb-4">
                <span class="text-xs font-bold bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 px-2 py-1 rounded">REF: ${reportURN}</span>
                <span class="text-xs text-slate-400 ml-2">${new Date().toLocaleDateString()}</span>
            </div>
          `;
          
          document.getElementById('report-content').innerHTML = headerHTML + htmlContent;
          switchView('result');
        } else {
          alert("Error generating report. Please check the server.");
          switchView('form');
        }
      } catch (err) {
        console.error("Submission Error:", err);
        alert("Network error. Check console for details: " + err.message);
        switchView('form');
      }
    });

    function switchView(viewName) {
      Object.values(views).forEach(el => el.classList.add('hidden'));
      views[viewName].classList.remove('hidden');
      window.scrollTo(0, 0);
    }

    window.resetApp = () => {
      document.getElementById('riskForm').reset();
      document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      document.querySelectorAll('.detail-box').forEach(box => box.classList.add('hidden'));
      storedImages = []; // Clear images
      document.getElementById('file-name').textContent = "JPG/PNG (Auto-Compressed)";
      switchView('form');
    };
  </script>
